# ShowDoc MCP 服务 - 核心功能需求文档

## 功能概述

开发一个 Python 模块，用于通过 ShowDoc 文档 URL 和 Cookie 自动获取指定节点或全部节点的接口数据，并保持树状结构返回。

## 输入参数

### 必需参数

1. **base_url** (str)
   - 说明：ShowDoc 文档页面的 URL 地址
   - 示例：`https://doc.cqfengli.com/web/#/90/`
   - 注意：URL 中包含 item_id（如示例中的 `90`），需要从 URL 中提取

2. **cookie** (str)
   - 说明：访问 ShowDoc 所需的认证 Cookie
   - 示例：`think_language=zh-CN; PHPSESSID=tg7ja3au64div38p58abmomtt6`
   - 格式：标准 Cookie 字符串，多个 Cookie 之间用分号和空格分隔

3. **node_name** (str, optional)
   - 说明：指定要获取的节点名称（分类名称）
   - 示例：
     - `"订单"` - 获取名为 "订单" 的节点及其所有子节点下的接口数据
     - `"全部"` 或 `"all"` 或 `None` - 获取所有节点的接口数据
   - 默认值：`None`（获取全部）

## 处理流程

### 步骤 1：解析 URL 并访问主页面

1. 从 `base_url` 中提取：
   - 服务器基础地址（如 `https://doc.cqfengli.com`）
   - item_id（从 URL 路径或哈希中提取，如 `#/90/` 中的 `90`）

2. 访问主页面获取配置
   - 接口：`GET {base_url}/web/`
   - 目的：获取服务器配置信息（API 基础路径等）
   - 参考：`api_docs/api_example_01.txt`

### 步骤 2：获取文档目录结构

- 接口：`POST {server_base}/server/index.php?s=/api/item/info`
- 请求参数：`item_id={item_id}`
- 目的：获取整个文档项目的完整目录树结构，包括：
  - 所有分类（category）的层级关系
  - 每个分类下的页面（page）列表
  - 每个分类和页面的 ID、名称等信息
- 参考：`api_docs/api_example_02.txt`
- 返回数据结构：树状结构，包含 `catalogs`（子分类）和 `pages`（页面列表）

### 步骤 3：获取额外配置（可选）

- 接口：`POST {server_base}/server/index.php?s=/api/item/getAiKnowledgeBaseConfig`
- 请求参数：`item_id={item_id}`
- 目的：获取 AI 知识库配置（可选步骤）
- 参考：`api_docs/api_example_03.txt`

### 步骤 4：筛选节点并获取页面详情

1. **节点筛选逻辑**：
   - 如果 `node_name` 为 `None`、`"全部"` 或 `"all"`：
     - 遍历步骤 2 返回的整个目录树
   - 否则：
     - 在目录树中搜索名称匹配 `node_name` 的节点（分类）
     - 如果找到，获取该节点及其所有子节点的数据
     - 如果未找到，返回空结果或抛出异常

2. **获取页面详情**：
   - 对于筛选出的每个页面（page），调用：
   - 接口：`POST {server_base}/server/index.php?s=/api/page/info`
   - 请求参数：`page_id={page_id}`
   - 参考：`api_docs/api_example_04.txt`

3. **数据处理**：
   - 返回的 `page_content` 字段是 HTML 实体编码的 JSON 字符串
   - 需要进行 HTML 实体解码（`html.unescape()`）
   - 然后解析为 JSON 对象
   - 解析后的数据包含完整的 API 接口定义：
     - 请求方法（GET/POST 等）
     - 请求 URL
     - 请求参数（query、body、headers、cookies 等）
     - 响应格式和示例

## 输出格式

### 返回数据结构

返回一个树状结构，保持原有的层级关系：

```python
{
    "item_id": "49",
    "item_name": "项目名称",
    "nodes": [
        {
            "cat_id": "388",
            "cat_name": "分类名称",
            "level": 4,
            "parent_cat_id": "382",
            "pages": [
                {
                    "page_id": "3825",
                    "page_title": "页面标题",
                    "api_info": {
                        "method": "get",
                        "url": "...",
                        "request": {...},
                        "response": {...}
                    }
                }
            ],
            "children": [  # 子分类
                ...
            ]
        }
    ]
}
```

### 数据特点

- 保持原有的树状层级结构
- 每个页面包含完整的 API 接口定义
- 支持递归的节点结构（分类下可以有子分类）

## 技术实现要点

1. **URL 解析**：
   - 从 `https://doc.cqfengli.com/web/#/90/` 中提取：
     - 服务器地址：`https://doc.cqfengli.com`
     - item_id：`90`（从哈希路径中提取）

2. **Cookie 处理**：
   - 直接使用提供的 Cookie 字符串，设置到 HTTP 请求头中

3. **HTML 实体解码**：
   - 使用 Python 的 `html.unescape()` 解码
   - 然后使用 `json.loads()` 解析

4. **错误处理**：
   - 网络请求错误
   - 认证失败（Cookie 无效）
   - 节点不存在
   - 数据解析错误

5. **性能优化**：
   - 可以考虑并发获取多个页面的详情（如果页面数量很多）

## 相关文档

- `../api_docs/README.md` - 详细的接口调用文档
- `../api_docs/api_example_*.txt` - 各步骤的请求/响应示例
